<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XAUUSD Candlestick Chart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #fff;
      color: #000;
    }

    #livePrice {
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    .range-buttons .btn {
      margin-right: 5px;
    }

    #ohlcDisplay {
      margin-top: 10px;
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    #chart {
      max-width: 100%;
      min-height: 400px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="mb-3">XAUUSD Chart</h1>
    <div id="livePrice" class="mb-3">Live Price: <span id="price">Loading...</span></div>
    <div class="range-buttons mb-3">
      <button class="btn btn-outline-primary active" data-range="1D">1D</button>
      <button class="btn btn-outline-primary" data-range="1W">1W</button>
      <button class="btn btn-outline-primary" data-range="3M">3M</button>
      <button class="btn btn-outline-primary" data-range="6M">6M</button>
      <button class="btn btn-outline-primary" data-range="1Y">1Y</button>
    </div>
    <div id="chart" class="mb-3"></div>
    <div id="ohlcDisplay">O: -- H: -- L: -- C: --</div>
  </div>

  <script>
    const API_BASE = "https://livechart.zedcapital.com:5000";
    const priceEl = document.getElementById("price");
    const ohlcEl = document.getElementById("ohlcDisplay");
    const chartContainer = document.getElementById("chart");
    const rangeButtons = document.querySelectorAll(".range-buttons button");

    const RANGES = {
      "1D": { duration: 86400, interval: 60 },
      "1W": { duration: 86400 * 7, interval: 3600 },
      "3M": { duration: 86400 * 90, interval: 86400 },
      "6M": { duration: 86400 * 180, interval: 86400 },
      "1Y": { duration: 86400 * 365, interval: 2592000 },
    };

    let currentRange = "1D";
    let chart = null;

    async function fetchLivePrice() {
      try {
        const res = await fetch(`${API_BASE}/last-price?symbol=XAUUSD`);
        const data = await res.json();
        priceEl.textContent = parseFloat(data.last_price).toFixed(2);
      } catch (err) {
        priceEl.textContent = "--";
        console.error("Error fetching live price:", err);
      }
    }

    async function fetchChartData(range) {
      const now = Math.floor(Date.now() / 1000);
      const from = now - RANGES[range].duration;
      const url = `${API_BASE}/api/chart/get?symbol=XAUUSD&from=${from}&to=${now}&data=dohlc`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        if (json.retcode !== "0 Done") throw new Error("Chart data not ready");

        return json.answer.map(bar => ({
          x: new Date(bar[0] * 1000),
          y: [bar[1], bar[2], bar[3], bar[4]]
        }));
      } catch (err) {
        console.error("Error fetching chart data:", err);
        return [];
      }
    }

    async function renderChart() {
      const seriesData = await fetchChartData(currentRange);

      const options = {
        chart: {
          type: "candlestick",
          height: 500,
          animations: { enabled: true },
          toolbar: { show: true },
          events: {
            mouseMove: (event, chartContext, config) => {
              const idx = config.dataPointIndex;

              // Check if index is valid and series data exists
              const seriesData = chartContext?.w?.globals?.initialSeries?.[0]?.data;
              if (idx >= 0 && seriesData && seriesData[idx]) {
                const [o, h, l, c] = seriesData[idx].y;
                ohlcEl.textContent = `O: ${o.toFixed(2)} H: ${h.toFixed(2)} L: ${l.toFixed(2)} C: ${c.toFixed(2)}`;
              } else {
                ohlcEl.textContent = "O: -- H: -- L: -- C: --";
              }
            }
          }
        },
        series: [{ name: "XAUUSD", data: seriesData }],
        xaxis: { type: "datetime" },
        tooltip: { enabled: false },
        title: { text: `XAUUSD Candlestick - ${currentRange}`, align: "left" }
      };

      if (chart) chart.destroy();
      chart = new ApexCharts(chartContainer, options);
      chart.render();
    }

    async function updateLatestCandle() {
      if (!chart) return;

      const latestData = await fetchChartData(currentRange);
      if (latestData.length > 0) {
        chart.updateSeries([{ data: latestData }]);
      }
    }

    // Range button click
    rangeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        rangeButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentRange = btn.getAttribute("data-range");
        renderChart();
      });
    });

    // Init
    fetchLivePrice();
    renderChart();
    setInterval(fetchLivePrice, 1000);        // Update live price every second
    setInterval(updateLatestCandle, 60000);  // Refresh chart every 60 seconds
  </script>
</body>

</html>